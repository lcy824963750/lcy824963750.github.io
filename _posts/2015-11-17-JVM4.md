---
layout: post
title: '《深入JVM》之Java虚拟机的体系结构'
date: '2015-11-17'
header-img: "img/post-bg-web.jpg"
tags:
     - JVM
author: 'lcy'
---

### Java虚拟机

#### 一.Java虚拟机是什么?
&emsp;&emsp;通常我们说Java虚拟机，可能是以下三种情况的一种：
&emsp;&emsp;1.抽象规范
&emsp;&emsp;2.一个具体的实现
&emsp;&emsp;3.一个运行中的虚拟机实例

#### 二.Java虚拟机的生命周期
&emsp;&emsp;每启动一个Java程序，就会创建一个Java虚拟机实例，当该程序退出，该虚拟机实例也就退出了。
&emsp;&emsp;Java虚拟机内部有两种线程，守护线程和非守护线程，守护线程通常是由虚拟机自己使用的，但是Java虚拟机也可以把它创建的其他线程标记为守护线程，而Java的初始线程，就是开始于main的那个，是非守护线程，当程序中所有的非守护线程都结束时，虚拟机实例也就自动退出了。

#### 三.Java虚拟机的体系结构
&emsp;&emsp;1.数据类型
&emsp;&emsp;Java虚拟机的数据类型也有两种，基本数据类型和引用数据类型，与Java类似，Java中的基本数据类型都是JVM中的基本数据类型，boolean除外，boolean在JVM中会由整数表示，0代表false，非0代表true。JVM中还有一个Java中没有的数据类型，returnAddress，用来完成finally功能。
&emsp;&emsp;2.字长的考量
&emsp;&emsp;JVM中，最基本的数据单元就是字，它的大小由每个虚拟机的设计者来决定的。字长必须足够大，至少一个字单元就足以持有byte、short、int、char、float、returnAddress、references，两个字单元就足以持有long或者double类型的变量，因此，JVM的设计者至少得选择32位作为字长。JVM的字长虽然在不同的虚拟机实现中可能不同，但是这只是虚拟机的内部属性，不会影响程序的运行。
&emsp;&emsp;3.类装载子系统
&emsp;&emsp;类装载器子系统除了要定位和导入二进制文件外，还必须负责验证被导入类的正确性，为类变量分配并初始化内存，以及帮助解析符号引用。这些动作须按照以下动作进行：
&emsp;&emsp;（1）装载-查找并装载类型的二进制数据
&emsp;&emsp;（2）连接-执行验证、准备以及解析
&emsp;&emsp;验证：确认被导入类型的正确性
&emsp;&emsp;准备：为类变量分配内存，并将其初始化为默认值
&emsp;&emsp;解析：把类型中的符号引用转化为直接引用
&emsp;&emsp;（3）初始化-把类变量初始化为正确的初始值。
&emsp;&emsp;4.方法区
&emsp;&emsp;JVM装载某个类时，使用类装载器定位某个class文件，然后读入这个class文件，然后把它传输到JVM中，紧接着虚拟机提取其中的类型信息，并把信息存储到方法区中，该类型中的类变量也是存在方法区中。

&emsp;&emsp;方法区的几个特点:

* &emsp;&emsp;所有线程共享方法区
* &emsp;&emsp;方法区大小不是固定的
* &emsp;&emsp;方法区也可以被垃圾回收

&emsp;&emsp;5.堆
&emsp;&emsp;Java程序运行时创建的所有类实例或者数组都放在堆中。一个Java虚拟机实例中只有一个堆空间。JVM中有分配新内存的指令，却没有回收内存的指令，所以只能通过GC来完成回收，它会回收不再被运行的程序引用的对象。
&emsp;&emsp;两种常见的堆空间设计
&emsp;&emsp;（1）、堆空间分为两部分，句柄池和对象池，一个对象引用就是一个指向句柄池的本地指针，句柄池每个条目有两部分，一个指向对象实例变量的指针，一个指向方法区类型数据的指针。
&emsp;&emsp;（2）、对象指针直接指向一组数据，该数据包括对象实例数据和指向方法区中类数据的指针。

&emsp;&emsp;6.程序计数器
&emsp;&emsp;对运行中的Java程序来说，每一个线程都有自己的PC寄存器，它在该线程启动时创建的，PC寄存器的大小是一个字长，当执行某个Java方法时，PC寄存器的内容总是下一条将被执行指令的地址。特殊的，若是线程在执行本地方法，那么PC寄存器的内容是"undefined"。

&emsp;&emsp;7.Java栈
&emsp;&emsp;每当启动一个新的线程时，JVM都会为它分配一个Java栈。Java栈以帧为单位保存线程的运行状态，JVM只对栈执行两种操作，以帧为单位的压栈或者出栈。
&emsp;&emsp;每当Java线程调用一个Java方法，虚拟机都会在该线程的Java栈中压入一个新帧，这个帧成为当前帧。执行方法时，使用这个帧来存储参数、局部变量、中间运算结果等等。
&emsp;&emsp;Java方法可能以两种方式结束，调用return方法或者抛出异常，不管以哪种方式结束，虚拟机都会将当前帧弹出Java栈然后释放，这样上一个方法的帧就成为了当前帧。
&emsp;&emsp;Java栈上的所有数据都是此线程所私有的，任何一个线程都不能访问其他线程的栈数据。

&emsp;&emsp;8.栈帧
&emsp;&emsp;帧栈由三部分组成，局部变量区、操作数栈和栈数据区。
&emsp;&emsp;局部变量区：Java帧栈的局部变量区被组织为一个以字长为单位，从0开始计数的数组，字节码指令通过从0开始的索引来使用其中的数据。long和double这种64位长度的，占据两个位置，其他的占据一个位置，假设long或者double类型的变量占据3、4位置，那么通过开始的索引3访问即可。
&emsp;&emsp;操作数栈：同样被组织为一个以字长为单位的数组，但是访问方式和局部变量区不同，只能通过基本的入栈和出栈操作来访问。
&emsp;&emsp;帧数据区：Java栈帧需要一些数据来进行常量池的解析、正常方法返回以及异常派发机制，这些信息都保存在帧数据区中。

&emsp;&emsp;9.执行引擎
&emsp;&emsp;执行引擎是Java虚拟机实现的核心，执行引擎的行为使用指令集来定义，对于每条指令，规范都定义了当实现执行到当前指令应该处理什么。
&emsp;&emsp;运行中Java程序的每一个线程，都是一个独立的虚拟机执行引擎的实例。所有属于用户运行程序的线程，都是在实际工作的执行引擎。


> 如有任何知识产权、版权问题或理论错误，还请指正。
>
> 转载请注明原作者及以上信息。
